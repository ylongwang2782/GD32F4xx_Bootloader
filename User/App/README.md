# STM32F4xx YMODEM Bootloader

这是一个基于STM32F429ZI的YMODEM协议Bootloader程序，支持通过UART4接收固件并更新到Flash。

## 功能特性

- 支持YMODEM协议固件传输
- CRC16校验确保数据完整性
- 自动Flash擦除和写入
- 应用程序有效性检查
- 自动跳转到应用程序
- 简化的按键控制流程（按住KEY1上电进入bootloader）
- **无超时等待**：bootloader模式下永久等待固件传输

## 内存分配

- **Bootloader地址**: 0x08000000 (0-32KB)
- **应用程序地址**: 0x08008000 (32KB开始)
- **总Flash大小**: 2048KB

## 硬件连接

### UART4配置
- **TX**: PA0 (发送)
- **RX**: PA1 (接收)
- **波特率**: 115200
- **数据位**: 8
- **停止位**: 1
- **校验位**: 无

### LED和按键
- **运行LED**: PC13
- **KEY1按键**: PG10 (按下进入固件更新模式)

## 使用方法

### 1. 启动行为（简化流程）
- **需要烧录固件时**：按住KEY1按键，然后上电/复位，系统进入bootloader模式
- **正常启动时**：直接上电/复位（不按KEY1），系统检查应用程序并自动跳转

### 2. Bootloader模式（按住KEY1上电）
- 系统显示bootloader信息
- LED常亮表示已进入bootloader模式
- **无超时限制**：一直等待YMODEM固件传输，不会超时退出
- 直接等待YMODEM固件传输，无需额外命令
- 传输成功后自动跳转到新应用程序
- 传输出错时自动重试，不会因超时而退出

### 3. 正常启动模式（直接上电）
- 检查是否存在有效应用程序
- **有效应用程序**：直接跳转到应用程序
- **无效应用程序**：提示按住KEY1复位进入bootloader模式

### 4. YMODEM传输步骤
1. 按住KEY1按键并复位进入bootloader模式
2. 看到"Ready to receive firmware"提示后，bootloader会每3秒发送'C'信号
3. **任何时候**启动YMODEM传输，TeraTerm会自动检测到'C'信号
4. 使用支持YMODEM的终端软件发送.bin文件
5. 传输完成后显示成功信息，系统自动重启到新应用程序

## 应用程序要求

应用程序需要配置为从地址0x08008000开始：

### 链接脚本修改
```ld
MEMORY
{
    FLASH (rx) : ORIGIN = 0x08008000, LENGTH = 2016K
    RAM (rwx)  : ORIGIN = 0x20000000, LENGTH = 256K
}
```

### 向量表重定位
在应用程序的main()函数开始处添加：
```c
/* 重定位向量表到应用程序地址 */
SCB->VTOR = 0x08008000;
```

## 编译说明

使用CMake构建系统：
```bash
mkdir build
cd build
cmake ..
make
```

## 测试建议

1. 首先烧录Bootloader到0x08000000
2. 直接上电，应该提示"No valid application found"
3. 按住KEY1复位，进入bootloader模式
4. 通过YMODEM上传一个简单的测试应用程序
5. 传输完成后验证自动跳转功能
6. 再次直接上电，验证直接启动应用程序
7. 测试按住KEY1复位重复更新功能

## 故障排除

### 常见问题
1. **应用程序无法启动**: 检查向量表重定位和链接脚本配置
2. **YMODEM传输失败**: 检查CRC设置和波特率匹配
3. **Flash写入失败**: 确认扇区擦除成功
4. **TeraTerm检测不到启动信号**: 
   - 确保按住KEY1复位进入bootloader模式
   - 等待看到周期性的'.'字符表示正在发送'C'信号
   - 现在支持随时启动传输，不需要严格的时序
5. **传输卡在100%**: 
   - 新版本已修复YMODEM结束协议处理
   - 传输完成后会显示明确的成功信息

### 调试信息
Bootloader会通过UART4输出详细的调试信息，包括：
- 启动状态
- 应用程序有效性检查
- 文件传输进度
- 错误信息

## 安全注意事项

- Bootloader占用Flash前32KB，应用程序不能覆盖此区域
- 建议在关键应用中添加应用程序完整性检查
- 确保在更新过程中系统电源稳定
- KEY1按键提供了可靠的硬件进入方式，避免软件故障时无法进入更新模式
